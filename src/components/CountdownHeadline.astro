---
import { t } from "astro-i18n";

import Center from "@components/Center.astro";

interface Props {
  withHeadline?: boolean;
}

const { withHeadline = false } = Astro.props;
---

<my-countdown-headline>
  <Center class="pb-1 lg:pb-2">
    <h3 class="text-center font-serif text-2xl lg:text-3xl">{t("countdown.before")}</h3>
  </Center>

  <Center>
    <div class="grid auto-cols-max grid-flow-col gap-5 text-center">
      <div class="flex flex-col">
        <span class="countdown font-serif text-6xl lg:text-7xl xl:text-8xl">
          <span data-id="myCountdownDayValue" style="--value:0;"></span>
        </span>
        <span data-id="myCountdownDayText">{t("countdown.days")}</span>
      </div>
      <div class="flex flex-col">
        <span class="countdown font-serif text-6xl lg:text-7xl xl:text-8xl">
          <span data-id="myCountdownHourValue" style="--value:0;"></span>
        </span>
        <span data-id="myCountdownHourText">{t("countdown.hours")}</span>
      </div>
      <div class="flex flex-col">
        <span class="countdown font-serif text-6xl lg:text-7xl xl:text-8xl">
          <span data-id="myCountdownMinuteValue" style="--value:0;"></span>
        </span>
        <span data-id="myCountdownMinuteText">{t("countdown.minutes")}</span>
      </div>
      <div class="flex flex-col">
        <span class="countdown font-serif text-6xl lg:text-7xl xl:text-8xl">
          <span data-id="myCountdownSecondValue" style="--value:0;"></span>
        </span>
        <span data-id="myCountdownSecondText">{t("countdown.seconds")}</span>
      </div>
    </div>
  </Center>

  {
    withHeadline && (
      <Center class="pt-2 lg:pt-4">
        <h3 data-id="myCountdownHeadline" class="text-center font-serif text-2xl lg:text-3xl" />
      </Center>
    )
  }
</my-countdown-headline>

<script>
  import { t } from "astro-i18n";

  const msgUntil = "... " + t("countdown.until");
  const msgAfter = "... " + t("countdown.after");

  const COUNT_DOWN_DATE = new Date("2025-11-09T11:00:00.000Z").getTime();
  // const COUNT_DOWN_DATE = new Date("2024-09-11T13:33:35.000Z").getTime();

  class MyCountdownHeadline extends HTMLElement {
    private intervalId: any = null;

    constructor() {
      super();

      this.setTimeValues();

      this.intervalId = setInterval(this.setTimeValues, 1000);
    }

    /**
     * @override

     * Called each time the element is removed from the document.
     *
     * @see https://developer.mozilla.org/en-US/docs/Web/API/Web_components/Using_custom_elements#custom_element_lifecycle_callbacks
     */
    disconnectedCallback() {
      clearInterval(this.intervalId);
    }

    private setTimeValues = () => {
      // Find the distance between now and the countdown date
      const distance = COUNT_DOWN_DATE - new Date().getTime();
      const daysDiff = distance / (1000 * 60 * 60 * 24);
      const hoursDiff = (distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60);
      const minutesDiff = (distance % (1000 * 60 * 60)) / (1000 * 60);
      const secondsDiff = (distance % (1000 * 60)) / 1000;

      // Time calculations for days, hours, minutes and seconds
      // floor down if positive (time to wedding), ceil up if negative (time from wedding)
      const days = Math.abs(daysDiff >= 0 ? Math.floor(daysDiff) : Math.ceil(daysDiff));
      const hours = Math.abs(hoursDiff >= 0 ? Math.floor(hoursDiff) : Math.ceil(hoursDiff));
      const minutes = Math.abs(minutesDiff >= 0 ? Math.floor(minutesDiff) : Math.ceil(minutesDiff));
      const seconds = Math.abs(secondsDiff >= 0 ? Math.floor(secondsDiff) : Math.ceil(secondsDiff));

      // Display the result in the elements

      // BUT days, daisy countdown can handle only 0..99,
      this.querySelector<HTMLSpanElement>('[data-id="myCountdownDayValue"]')?.style.setProperty(
        "--value",
        hours.toString(),
      );
      const daysTextEl = this.querySelector<HTMLSpanElement>('[data-id="myCountdownDayText"]');
      if (daysTextEl) {
        daysTextEl.innerText = t("countdown.days", { days: days });
      }

      this.querySelector<HTMLSpanElement>('[data-id="myCountdownHourValue"]')?.style.setProperty(
        "--value",
        hours.toString(),
      );
      const hoursTextEl = this.querySelector<HTMLSpanElement>('[data-id="myCountdownHourText"]');
      if (hoursTextEl) {
        hoursTextEl.innerText = t("countdown.hours", { hours: hours });
      }

      this.querySelector<HTMLSpanElement>('[data-id="myCountdownMinuteValue"]')?.style.setProperty(
        "--value",
        minutes.toString(),
      );
      const minutesTextEl = this.querySelector<HTMLSpanElement>('[data-id="myCountdownMinuteText"]');
      if (minutesTextEl) {
        minutesTextEl.innerText = t("countdown.minutes", { minutes: minutes });
      }

      this.querySelector<HTMLSpanElement>('[data-id="myCountdownSecondValue"]')?.style.setProperty(
        "--value",
        seconds.toString(),
      );
      const secondsTextEl = this.querySelector<HTMLSpanElement>('[data-id="myCountdownSecondText"]');
      if (secondsTextEl) {
        secondsTextEl.innerText = t("countdown.seconds", { seconds: seconds });
      }

      const myCountdownHeadline = this.querySelector<HTMLHeadingElement>('[data-id="myCountdownHeadline"]');
      if (myCountdownHeadline != null) {
        myCountdownHeadline.innerText = distance > 0 ? msgUntil : msgAfter;
      }
    };
  }

  // Tell the browser to use our AstroHeart class for <astro-heart> elements.
  customElements.define("my-countdown-headline", MyCountdownHeadline);
</script>
